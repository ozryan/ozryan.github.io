<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title> - Windows用Docker部署Redis集群</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">

          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js" integrity="sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy" crossorigin="anonymous"></script>
              
          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
                  onload="renderMathInElement(document.body);"></script>
              
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;www.fewth.com&#x2F;site.css">
          
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">Even</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;www.fewth.com">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;www.fewth.com&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;www.fewth.com&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;www.fewth.com&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;www.fewth.com">Even</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;www.fewth.com">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;www.fewth.com&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;www.fewth.com&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;www.fewth.com&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://www.fewth.com/windowsyong-dockerbu-shu-redisji-qun/#1-yu-bei-zhi-shi" class="toc-link">1 预备知识</a>
                    
                </li>
                
                <li>
                    <a href="https://www.fewth.com/windowsyong-dockerbu-shu-redisji-qun/#2-ji-ben-bu-zou" class="toc-link">2 基本步骤</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://www.fewth.com/windowsyong-dockerbu-shu-redisji-qun/#2-1-huo-qu-redisjing-xiang" class="toc-link">2.1 获取redis镜像</a>
                        </li>
                        
                        <li>
                            <a href="https://www.fewth.com/windowsyong-dockerbu-shu-redisji-qun/#2-2-zai-ben-ji-chuang-jian-pei-zhi-wen-jian" class="toc-link">2.2 在本机创建配置文件</a>
                        </li>
                        
                        <li>
                            <a href="https://www.fewth.com/windowsyong-dockerbu-shu-redisji-qun/#2-3-chuang-jian-yi-ge-docker-network" class="toc-link">2.3 创建一个Docker Network</a>
                        </li>
                        
                        <li>
                            <a href="https://www.fewth.com/windowsyong-dockerbu-shu-redisji-qun/#2-4-yong-ben-di-pei-zhi-wen-jian-qi-dong-duo-ge-redisjie-dian" class="toc-link">2.4 用本地配置文件启动多个redis节点</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    <a href="https://www.fewth.com/windowsyong-dockerbu-shu-redisji-qun/#3-zai-xiang-mu-zhong-shi-yong" class="toc-link">3 在项目中使用</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;www.fewth.com&#x2F;windowsyong-dockerbu-shu-redisji-qun&#x2F;">Windows用Docker部署Redis集群</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2021-04-14</span>
            
        </div>
    </header>

    <div class="post-content">
      <h2 id="1-yu-bei-zhi-shi">1 预备知识</h2>
<p>除了知道<code>Docker</code>和<code>Redis cluster</code>的基本概念和常规部署流程外，还需要知道<code>Docker</code>里的几个概念：</p>
<!--more-->
<ul>
<li><a href="https://docs.docker.com/storage/volumes/">Volume</a>：独立于<code>container</code>的一个数据保存区域，可以被<code>container</code>共享，也可以用来把本地的配置文件映射过去供<code>container</code>使用。</li>
<li><a href="https://docs.docker.com/network/bridge/">Network</a>：<code>Docker</code>内部的&quot;网络&quot;，让不同的<code>container</code>可以互相访问，这是<code>redis</code>官方建议的在<code>docker</code>里做<code>cluster</code>时的方式。我们这里主要用<code>bridge</code>模式。</li>
</ul>
<h2 id="2-ji-ben-bu-zou">2 基本步骤</h2>
<h3 id="2-1-huo-qu-redisjing-xiang">2.1 获取redis镜像</h3>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">docker pull redis
</span></code></pre><h3 id="2-2-zai-ben-ji-chuang-jian-pei-zhi-wen-jian">2.2 在本机创建配置文件</h3>
<p>在本地的一个文件夹内创建一个<code>redis-cluster.conf</code>配置文件，里面仅包含简单的集群配置信息：</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">port 6379
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
appendonly yes
</span></code></pre><h3 id="2-3-chuang-jian-yi-ge-docker-network">2.3 创建一个<code>Docker Network</code></h3>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">docker network create my-net
</span></code></pre><h3 id="2-4-yong-ben-di-pei-zhi-wen-jian-qi-dong-duo-ge-redisjie-dian">2.4 用本地配置文件启动多个redis节点</h3>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">docker run -d --name redis-1 --network my-net -v C:\Users\xxx\Desktop\conf\redis-cluster.conf:/usr/local/etc/redis/redis.conf redis redis-server /usr/local/etc/redis/redis.conf
</span></code></pre>
<p>上面这条命令里的几个参数：</p>
<ul>
<li>docker run：运行一个<code>container</code></li>
<li>-d:后台运行</li>
<li><code>--name</code>：自定义的container的名称</li>
<li><code>--network</code>:容器加入的网络</li>
<li>-v:volume映射,“本机地址：docker地址”的格式，&quot;C:\Users\xxx\Desktop\conf\redis-cluster.conf&quot;是刚才存放的配置文件地址（加文件名），&quot;/usr/local/etc/redis/redis.conf&quot;是我们的<code>volume</code>挂载的地址,这里我们把配置文件的名称也改掉了，本机是<code>redis-cluster.conf</code>，<code>volume</code>里是<code>redis.conf</code></li>
<li>redis：我们的<code>image</code>名称，默认用最新版</li>
<li>redis-server /usr/local/etc/redis/redis.conf:这跟我们常规启动<code>redis</code>服务是一样的，用我们刚才映射过去的配置文件启动。</li>
</ul>
<p>把上面的&quot;redis-1&quot;换成&quot;redis-2&quot;...&quot;redis-6&quot;，启动6个节点，注意这里配置文件不用改，端口也全是6379,因为<code>network</code>会给我们每一个节点分配不同的IP。</p>
<p>完成后查看一下容器：</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">docker ps
</span></code></pre><details>
<summary>查看输出</summary>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS      NAMES

cd6d8811ce44   redis     &quot;docker-entrypoint.s…&quot;   2 seconds ago    Up 1 second     6379/tcp   redis-6

f67c48b6ea9d   redis     &quot;docker-entrypoint.s…&quot;   8 seconds ago    Up 7 seconds    6379/tcp   redis-5

4fe4a89469da   redis     &quot;docker-entrypoint.s…&quot;   13 seconds ago   Up 12 seconds   6379/tcp   redis-4

950537cd501e   redis     &quot;docker-entrypoint.s…&quot;   21 seconds ago   Up 20 seconds   6379/tcp   redis-3

4d09c04e87b1   redis     &quot;docker-entrypoint.s…&quot;   34 seconds ago   Up 32 seconds   6379/tcp   redis-2

d15c0933bc05   redis     &quot;docker-entrypoint.s…&quot;   12 minutes ago   Up 12 minutes   6379/tcp   redis-1
</span></code></pre></details>
<p>再查看一下network:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">docker network inspect my-net
</span></code></pre>
<p>可以看到我们的6个<code>container</code>都在里面，每个分配了不同的ID</p>
<details>
<summary>查看输出</summary> 
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"> {
        &quot;Name&quot;: &quot;my-net&quot;,
        &quot;Id&quot;: &quot;8fa94b07701cad47c4440298b2908fbadd0591b44999df2013a7e1eb4b7b541b&quot;,
        &quot;Created&quot;: &quot;2021-04-21T05:46:18.4468198Z&quot;,
        &quot;Scope&quot;: &quot;local&quot;,
        &quot;Driver&quot;: &quot;bridge&quot;,
        &quot;EnableIPv6&quot;: false,
        &quot;IPAM&quot;: {
            &quot;Driver&quot;: &quot;default&quot;,
            &quot;Options&quot;: {},
            &quot;Config&quot;: [
                {
                    &quot;Subnet&quot;: &quot;172.18.0.0/16&quot;,
                    &quot;Gateway&quot;: &quot;172.18.0.1&quot;
                }
            ]
        },
        &quot;Internal&quot;: false,
        &quot;Attachable&quot;: false,
        &quot;Ingress&quot;: false,
        &quot;ConfigFrom&quot;: {
            &quot;Network&quot;: &quot;&quot;
        },
        &quot;ConfigOnly&quot;: false,
        &quot;Containers&quot;: {
            &quot;4d09c04e87b1b99ebe7827181ce89f8bddd054b047ae24a4179d37ff0f98d271&quot;: {
                &quot;Name&quot;: &quot;redis-2&quot;,
                &quot;EndpointID&quot;: &quot;46faad0fc995299d176f941dd97e06b5a35f16a5a2b4b5d66f3ccf624363cebb&quot;,
                &quot;MacAddress&quot;: &quot;02:42:ac:12:00:03&quot;,
                &quot;IPv4Address&quot;: &quot;172.18.0.3/16&quot;,
                &quot;IPv6Address&quot;: &quot;&quot;
            },
            &quot;4fe4a89469da15e772d8a1437698b5832bc95310ebc59a18fb4860ec93c86595&quot;: {
                &quot;Name&quot;: &quot;redis-4&quot;,
                &quot;EndpointID&quot;: &quot;c2a84c3c7e8db91f4f694f10b390c1a78f702f2b65e71eeecbc51dc2288e28be&quot;,
                &quot;MacAddress&quot;: &quot;02:42:ac:12:00:05&quot;,
                &quot;IPv4Address&quot;: &quot;172.18.0.5/16&quot;,
                &quot;IPv6Address&quot;: &quot;&quot;
            },
            &quot;950537cd501eb2731dbd69890fd30c933f3246d2d85fca6cc51818b0c3fc5b31&quot;: {
                &quot;Name&quot;: &quot;redis-3&quot;,
                &quot;EndpointID&quot;: &quot;1bfe934156ff36b05a4c44c3695b02cef2a50f6a5fd3a75f52c03e3c900cbb7c&quot;,
                &quot;MacAddress&quot;: &quot;02:42:ac:12:00:04&quot;,
                &quot;IPv4Address&quot;: &quot;172.18.0.4/16&quot;,
                &quot;IPv6Address&quot;: &quot;&quot;
            },
            &quot;cd6d8811ce443f98a504e8466d2cd321f8129eae06b03b7667e4c145a308a880&quot;: {
                &quot;Name&quot;: &quot;redis-6&quot;,
                &quot;EndpointID&quot;: &quot;d0b9d092e6c38433d760f16781bd3cd2100b8f9c1b7f37f5c499e172fe0845d5&quot;,
                &quot;MacAddress&quot;: &quot;02:42:ac:12:00:07&quot;,
                &quot;IPv4Address&quot;: &quot;172.18.0.7/16&quot;,
                &quot;IPv6Address&quot;: &quot;&quot;
            },
            &quot;d15c0933bc05450410f4c1923e70493f1fd79b200c16341be0b5cda4c599bbfa&quot;: {
                &quot;Name&quot;: &quot;redis-1&quot;,
                &quot;EndpointID&quot;: &quot;7262111112b513c1d4c3e090fc4ae7b01bbc6adf0df337eb38fa311b04d92b45&quot;,
                &quot;MacAddress&quot;: &quot;02:42:ac:12:00:02&quot;,
                &quot;IPv4Address&quot;: &quot;172.18.0.2/16&quot;,
                &quot;IPv6Address&quot;: &quot;&quot;
            },
            &quot;f67c48b6ea9d8fb31ba8b1ec96ad6ea8cc1c246747608420814e79f59abfd56c&quot;: {
                &quot;Name&quot;: &quot;redis-5&quot;,
                &quot;EndpointID&quot;: &quot;a86deeae79f267f21e55e7ee06da7d12a627617e348398125c6303a12439cbdc&quot;,
                &quot;MacAddress&quot;: &quot;02:42:ac:12:00:06&quot;,
                &quot;IPv4Address&quot;: &quot;172.18.0.6/16&quot;,
                &quot;IPv6Address&quot;: &quot;&quot;
            }
        },
        &quot;Options&quot;: {},
        &quot;Labels&quot;: {}
    }
</span></code></pre></details>
<p>上面可以看到我们每一个<code>container</code>的IP，也可以用下面这条命令单独获取某个<code>container</code>的IP,比如获取redis-1这个<code>container</code>的IP:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">docker inspect --format=&#39;{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#39; $INSTANCE_ID
</span></code></pre>
<p>2.5 启动cluster</p>
<p>根据上面获取的IP，我们先进入redis1这个container</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">docker exec -it redis-1 /bin/bash
</span></code></pre>
<p>然后跟常规一样运行cluster</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">redis-cli --cluster create 172.18.0.2:6379 172.18.0.3:6379 172.18.0.4:6379 172.18.0.5:6379 172.18.0.6:6379 172.18.0.7:6379 --cluster-replicas 1
</span></code></pre>
<p>redis会自动分配slot，输入yes完成cluster。</p>
<p>完成以后，我们以cluster模式启动（还是在redis-1这个container里面）:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">redis -c -p 6379
</span></code></pre>
<p>测试下面4条语句可以观察到cluster自动在节点间跳转</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">set foo bar
set hello world
get foo
get bar
</span></code></pre><h2 id="3-zai-xiang-mu-zhong-shi-yong">3 在项目中使用</h2>
<p>因为我们的<code>network</code>对于主机来说并没有开放，所以在本地运行的项目并不能直接访问到这些IP。但是我们可以把项目打包部署到这个<code>network</code>里面，就可以直接使用这个<code>cluster</code>了。</p>

    </div>

    
    

    <div class="post-footer">
        
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;www.fewth.com&#x2F;javafan-xing-he-c-mo-ban-de-qu-bie&#x2F;">‹ JAVA泛型和C++模板的区别</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;www.fewth.com&#x2F;elasticsearchfen-bu-shi-sou-suo-yin-qing&#x2F;">elasticsearch分布式搜索引擎 ›</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;www.fewth.com&#x2F;even.js" ></script>
      
    </body>

</html>
