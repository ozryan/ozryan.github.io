<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>spring boot启动流程 - A few thoughts</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta http-equiv=cache-control content="no-transform">
<meta http-equiv=cache-control content="no-siteapp">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=author content="ozryan"><meta name=description content="本文用一个空的Spring Boot项目演示，从main方法开始顺着源码大概过一遍启动流程。
">
<meta name=generator content="Hugo 0.91.2 with theme even">
<link rel=canonical href=https://www.fewth.com/spring-boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/manifest.json>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5>
<link href=/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css rel=stylesheet>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous>
<meta property="og:title" content="spring boot启动流程">
<meta property="og:description" content="本文用一个空的Spring Boot项目演示，从main方法开始顺着源码大概过一遍启动流程。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.fewth.com/spring-boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-08-14T17:08:12+00:00">
<meta property="article:modified_time" content="2021-08-14T17:08:12+00:00">
<meta itemprop=name content="spring boot启动流程">
<meta itemprop=description content="本文用一个空的Spring Boot项目演示，从main方法开始顺着源码大概过一遍启动流程。"><meta itemprop=datePublished content="2021-08-14T17:08:12+00:00">
<meta itemprop=dateModified content="2021-08-14T17:08:12+00:00">
<meta itemprop=wordCount content="13340">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="spring boot启动流程">
<meta name=twitter:description content="本文用一个空的Spring Boot项目演示，从main方法开始顺着源码大概过一遍启动流程。"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>A few thoughts</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<a href=/>
<li class=mobile-menu-item>主页</li>
</a><a href=/post>
<li class=mobile-menu-item>归档</li>
</a><a href=/categories/>
<li class=mobile-menu-item>分类</li>
</a><a href=/about>
<li class=mobile-menu-item>关于</li>
</a>
</ul>
</nav>
<div class=container id=mobile-panel>
<header id=header class=header>
<div class=logo-wrapper>
<a href=/ class=logo>A few thoughts</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=/>主页</a>
</li><li class=menu-item>
<a class=menu-item-link href=/post>归档</a>
</li><li class=menu-item>
<a class=menu-item-link href=/categories/>分类</a>
</li><li class=menu-item>
<a class=menu-item-link href=/about>关于</a>
</li>
</ul>
</nav>
</header>
<main id=main class=main>
<div class=content-wrapper>
<div id=content class=content>
<article class=post>
<header class=post-header>
<h1 class=post-title>spring boot启动流程</h1>
<div class=post-meta>
<span class=post-time> 2021-08-14 </span>
<div class=post-category>
<a href=/categories//> [web 后端] </a>
</div>
<span class=more-meta> 约 13340 字 </span>
<span class=more-meta> 预计阅读 27 分钟 </span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class="post-toc-content always-active">
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#1-新建项目>1 新建项目</a></li>
<li><a href=#2-分析源码>2 分析源码</a>
<ul>
<li><a href=#21-实例化springapplicationspan-id21>2.1 实例化SpringApplication<span id=2.1></a>
<ul>
<li><a href=#211-span-id211webapplicationtypespan>2.1.1 <span id=2.1.1>webApplicationType</span></a></li>
<li><a href=#212-bootstrapregistryinitializers>2.1.2 bootstrapRegistryInitializers</a></li>
<li><a href=#213-span-id213setinitializersspan>2.1.3 <span id=2.1.3>setInitializers</span></a></li>
<li><a href=#214-span-id214setlistenersspan>2.1.4 <span id=2.1.4>setListeners</span></a></li>
<li><a href=#215-mainapplicationclass>2.1.5 mainApplicationClass</a></li>
</ul>
</li>
<li><a href=#22-运行run方法>2.2 运行run方法</a>
<ul>
<li><a href=#221-bootstrapcontext>2.2.1 bootstrapContext</a></li>
<li><a href=#222-configureheadlessproperty>2.2.2 configureHeadlessProperty()</a></li>
<li><a href=#223-listeners>2.2.3 listeners</a>
<ul>
<li><a href=#223-1-声明并初始化listeners变量>2.2.3-1 声明并初始化listeners变量</a></li>
<li><a href=#223-2-listenersstartingbootstrapcontext-thismainapplicationclass>2.2.3-2 listeners.starting(bootstrapContext, this.mainApplicationClass)</a></li>
</ul>
</li>
<li><a href=#224-applicationarguments-applicationarguments--new-defaultapplicationargumentsargs>2.2.4 ApplicationArguments applicationArguments = new DefaultApplicationArguments(args)</a></li>
<li><a href=#225-prepareenvironment>2.2.5 prepareEnvironment</a></li>
<li><a href=#226-configureignorebeaninfoenvironment>2.2.6 configureIgnoreBeanInfo(environment)</a></li>
<li><a href=#227-createapplicationcontext>2.2.7 createApplicationContext()</a></li>
<li><a href=#228-contextsetapplicationstartupthisapplicationstartup>2.2.8 context.setApplicationStartup(this.applicationStartup)</a></li>
<li><a href=#229-preparecontext>2.2.9 prepareContext</a></li>
<li><a href=#2210-refreshcontext>2.2.10 refreshContext</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#3-总结>3 总结</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<p>本文用一个空的<code>Spring Boot</code>项目演示，从<code>main</code>方法开始顺着源码大概过一遍启动流程。</p>
<h2 id=1-新建项目>1 新建项目</h2>
<p>从<a href=https://start.spring.io/>spring initializr</a>下载一个demo。我这里选的是<code>java11,maven,spring boot2.4.5</code>,dependencies里面选<code>Spring Web</code>。
启动项目以后在<code>Demo</code>文件夹内新建一个<code>HelloController</code></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>com.example.demo</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>org.springframework.web.bind.annotation.GetMapping</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.bind.annotation.RestController</span><span class=o>;</span>

<span class=nd>@RestController</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloController</span> <span class=o>{</span>
    <span class=nd>@GetMapping</span><span class=o>(</span><span class=s>&#34;/&#34;</span><span class=o>)</span>
    <span class=kd>public</span> <span class=n>String</span> <span class=nf>hello</span><span class=o>(){</span>
        <span class=k>return</span> <span class=s>&#34;hello&#34;</span><span class=o>;</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>启动项目，打开http://localhost:8080/，看到hello说明成功。</p>
<h2 id=2-分析源码>2 分析源码</h2>
<p>首先，<code>main</code>方法里只有一个调用<code>SpringApplication.run(DemoApplication.class, args)</code>，这里调用<code>SpringApplication</code>类的<code>run</code>方法，，<code>run</code>是一个静态方法，会触发<code>SpringApplication</code>类的初始化，具体初始化的内容后面用到的部分再说，<code>run</code>方法传入两个参数：</p>
<ul>
<li><code>DemoApplication.class</code>，当前类的<code>Class</code>对象</li>
<li><code>args</code>，<code>main</code>方法传递的参数，这里是空</li>
</ul>
<p>查看<code>run</code>方法，内部调用的最终形式为：<br>
<code>new SpringApplication(primarySources).run(args);</code><br>
这可以分成两步，第一步是实例化<code>SpringApplication</code>，第二步调用对象的<code>run</code>方法，这里的两个参数分别是：</p>
<ul>
<li>primarySources:new Class&lt;?>[]{DemoApplication.class}，把当前启动类的Class传入一个 <code>Class[]</code>数组</li>
<li>args:null，我们的demo里没有传入参数</li>
</ul>
<h3 id=21-实例化springapplicationspan-id21>2.1 实例化SpringApplication<span id=2.1></h3>
<p>我们先来看<code>SpringApplication</code>的实例化，最终执行实例化的是下面这段代码：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=nf>SpringApplication</span><span class=o>(</span><span class=n>ResourceLoader</span> <span class=n>resourceLoader</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;...</span> <span class=n>primarySources</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>this</span><span class=o>.</span><span class=na>resourceLoader</span> <span class=o>=</span> <span class=n>resourceLoader</span><span class=o>;</span><span class=c1>//null
</span><span class=c1></span>    <span class=n>Assert</span><span class=o>.</span><span class=na>notNull</span><span class=o>(</span><span class=n>primarySources</span><span class=o>,</span> <span class=s>&#34;PrimarySources must not be null&#34;</span><span class=o>);</span><span class=c1>//检查变量确保不为空
</span><span class=c1></span>
    <span class=c1>//把传入的参数放入一个Set&lt;Class&lt;?&gt;&gt;,Set中只有一个值：DemoApplication.class
</span><span class=c1></span>    <span class=k>this</span><span class=o>.</span><span class=na>primarySources</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;&gt;(</span><span class=n>Arrays</span><span class=o>.</span><span class=na>asList</span><span class=o>(</span><span class=n>primarySources</span><span class=o>));</span>

    <span class=k>this</span><span class=o>.</span><span class=na>webApplicationType</span> <span class=o>=</span> <span class=n>WebApplicationType</span><span class=o>.</span><span class=na>deduceFromClasspath</span><span class=o>();</span><span class=c1>//2.1.1
</span><span class=c1></span>    
    <span class=k>this</span><span class=o>.</span><span class=na>bootstrapRegistryInitializers</span> <span class=o>=</span> <span class=n>getBootstrapRegistryInitializersFromSpringFactories</span><span class=o>();</span><span class=c1>//2.1.2
</span><span class=c1></span>    <span class=n>setInitializers</span><span class=o>((</span><span class=n>Collection</span><span class=o>)</span> <span class=n>getSpringFactoriesInstances</span><span class=o>(</span><span class=n>ApplicationContextInitializer</span><span class=o>.</span><span class=na>class</span><span class=o>));</span><span class=c1>//2.1.3
</span><span class=c1></span>    <span class=n>setListeners</span><span class=o>((</span><span class=n>Collection</span><span class=o>)</span> <span class=n>getSpringFactoriesInstances</span><span class=o>(</span><span class=n>ApplicationListener</span><span class=o>.</span><span class=na>class</span><span class=o>));</span><span class=c1>//2.1.4
</span><span class=c1></span>    <span class=k>this</span><span class=o>.</span><span class=na>mainApplicationClass</span> <span class=o>=</span> <span class=n>deduceMainApplicationClass</span><span class=o>();</span><span class=c1>//2.1.5
</span><span class=c1></span><span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>实例化的过程中初始化了几个属性：</p>
<h4 id=211-span-id211webapplicationtypespan>2.1.1 <span id=2.1.1>webApplicationType</span></h4>
<p><code>WebApplicatonType</code>是一个<code>Enum</code>类型，有三个值：<code>REACTIVE</code>,<code>SERVLET</code>,<code>NONE</code>，通过<code>deduceFromClasspath()</code>方法推断类型。</p>
<ul>
<li><code>deduceFromClasspath()</code>引用<code>ClassUtils</code>类的<code>isPresent(String className, @Nullable ClassLoader classLoader)</code>方法来判断<code>className</code>对应的类是否存在，<code>className</code>是预定义的几个静态常量之一，这些常量的值是类的全限定名，<code>WebApplicatonType</code>通过判断这几个常量对应的类是否存在来推断<code>WebApplicatonType</code>的类型，具体逻辑看源码。
我们这里的结果是<code>WebApplicatonType.SERVLET</code></li>
</ul>
<h4 id=212-bootstrapregistryinitializers>2.1.2 bootstrapRegistryInitializers</h4>
<p>先看一下调用的方法：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>BootstrapRegistryInitializer</span><span class=o>&gt;</span> <span class=nf>getBootstrapRegistryInitializersFromSpringFactories</span><span class=o>()</span> <span class=o>{</span>
  <span class=c1>//创建一个ArrayList用来保存结果
</span><span class=c1></span>  <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>BootstrapRegistryInitializer</span><span class=o>&gt;</span> <span class=n>initializers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>

  <span class=n>getSpringFactoriesInstances</span><span class=o>(</span><span class=n>Bootstrapper</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>stream</span><span class=o>()</span>
      <span class=o>.</span><span class=na>map</span><span class=o>((</span><span class=n>bootstrapper</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=o>((</span><span class=n>BootstrapRegistryInitializer</span><span class=o>)</span> <span class=n>bootstrapper</span><span class=o>::</span><span class=n>initialize</span><span class=o>))</span>
      <span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=n>initializers</span><span class=o>::</span><span class=n>add</span><span class=o>);</span>
  <span class=n>initializers</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>getSpringFactoriesInstances</span><span class=o>(</span><span class=n>BootstrapRegistryInitializer</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
  <span class=k>return</span> <span class=n>initializers</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>getSpringFactoriesInstances(Bootstrapper.class)</code>这个方法，会尝试去项目的classpath下查找所有在<code>spring.factoires</code>文件中指定的<code>Bootstrapper.class</code>的实现类，后面的链式操作会根据结果获取对应的<code>BootstrapRegistryInitializer</code>并添加到返回值<code>initializers</code>中，<code>Bootstrapper</code>在springboot2.4.4以后标记为deprecated,并计划在2.6移除，由后面的<code>BootstrapRegistryInitializer</code>取代。</p>
<p>我们的demo中，下面的两个包内有<span id=springfactories><code>META-INF/spring.factories</code></span>这个文件：</p>
<ul>
<li>spring-boot-2.4.5.jar</li>
<li>spring-boot-autoconfigure-2.4.5.jar</li>
</ul>
<p>这一步并没有查找到相应的<code>BootstrapRegistryInitializer</code>，返回值为一个空的<code>ArrayList</code></p>
<h4 id=213-span-id213setinitializersspan>2.1.3 <span id=2.1.3>setInitializers</span></h4>
<p>这一步设置的是<code>private List&lt;ApplicationContextInitializer&lt;?>> initializers</code>这个字段，方法跟前面一样，通过查找<code>spring.factories</code>文件来取得相应的实现类，<a href=#springfactories>上面提到的两个文件</a>中都有<code>ApplicationContextInitializer.class</code>的信息，分别是：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=c>#spring-boot-2.4.5.jar/META-INF/spring.factories</span><span class=w>
</span><span class=w></span><span class=l>org.springframework.context.ApplicationContextInitializer=\</span><span class=w>
</span><span class=w></span><span class=l>org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer,\</span><span class=w>
</span><span class=w></span><span class=l>org.springframework.boot.context.ContextIdApplicationContextInitializer,\</span><span class=w>
</span><span class=w></span><span class=l>org.springframework.boot.context.config.DelegatingApplicationContextInitializer,\</span><span class=w>
</span><span class=w></span><span class=l>org.springframework.boot.rsocket.context.RSocketPortInfoApplicationContextInitializer,\</span><span class=w>
</span><span class=w></span><span class=l>org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c>#spring-boot-autoconfigure-2.4.5.jar/META-INF/spring.factories</span><span class=w>
</span><span class=w></span><span class=l>org.springframework.context.ApplicationContextInitializer=\</span><span class=w>
</span><span class=w></span><span class=l>org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer,\</span><span class=w>
</span><span class=w></span><span class=l>org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>所以这一步初始化了<code>initializers</code>，其列表包含7个实现类的信息。</p>
<h4 id=214-span-id214setlistenersspan>2.1.4 <span id=2.1.4>setListeners</span></h4>
<p>跟<a href=#2.1.3>setInitializers</a>类似，这一步初始化了<code>private List&lt;ApplicationListener&lt;?>> listeners</code>这个字段，列表包含9个实现类的信息。</p>
<h4 id=215-mainapplicationclass>2.1.5 mainApplicationClass</h4>
<p>通过<code>StackTraceElement</code>的反射信息来推判主启动类，这里是<code>com.example.demo.DemoApplication.class</code></p>
<h3 id=22-运行run方法>2.2 运行run方法</h3>
<p>run方法比前面的实例化过程要复杂，先看一下方法的主体：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=n>ConfigurableApplicationContext</span> <span class=nf>run</span><span class=o>(</span><span class=n>String</span><span class=o>...</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>StopWatch</span> <span class=n>stopWatch</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StopWatch</span><span class=o>();</span><span class=c1>//实例化一个计时器
</span><span class=c1></span>  <span class=n>stopWatch</span><span class=o>.</span><span class=na>start</span><span class=o>();</span><span class=c1>//启动计时器
</span><span class=c1></span>
  <span class=n>DefaultBootstrapContext</span> <span class=n>bootstrapContext</span> <span class=o>=</span> <span class=n>createBootstrapContext</span><span class=o>();</span><span class=c1>//2.2.1
</span><span class=c1></span>  <span class=n>ConfigurableApplicationContext</span> <span class=n>context</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span><span class=c1>//初始化context
</span><span class=c1></span>  <span class=n>configureHeadlessProperty</span><span class=o>();</span><span class=c1>//2.2.2
</span><span class=c1></span>  <span class=n>SpringApplicationRunListeners</span> <span class=n>listeners</span> <span class=o>=</span> <span class=n>getRunListeners</span><span class=o>(</span><span class=n>args</span><span class=o>);</span><span class=c1>//2.2.3
</span><span class=c1></span>  <span class=n>listeners</span><span class=o>.</span><span class=na>starting</span><span class=o>(</span><span class=n>bootstrapContext</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>mainApplicationClass</span><span class=o>);</span><span class=c1>//2.2.3
</span><span class=c1></span>  <span class=k>try</span> <span class=o>{</span>
    <span class=n>ApplicationArguments</span> <span class=n>applicationArguments</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultApplicationArguments</span><span class=o>(</span><span class=n>args</span><span class=o>);</span><span class=c1>//2.2.4
</span><span class=c1></span>    <span class=n>ConfigurableEnvironment</span> <span class=n>environment</span> <span class=o>=</span> <span class=n>prepareEnvironment</span><span class=o>(</span><span class=n>listeners</span><span class=o>,</span> <span class=n>bootstrapContext</span><span class=o>,</span> <span class=n>applicationArguments</span><span class=o>);</span><span class=c1>//2.2.5
</span><span class=c1></span>    <span class=n>configureIgnoreBeanInfo</span><span class=o>(</span><span class=n>environment</span><span class=o>);</span> <span class=c1>// 2.2.6
</span><span class=c1></span>    <span class=n>Banner</span> <span class=n>printedBanner</span> <span class=o>=</span> <span class=n>printBanner</span><span class=o>(</span><span class=n>environment</span><span class=o>);</span> <span class=c1>//获取banner
</span><span class=c1></span>    <span class=n>context</span> <span class=o>=</span> <span class=n>createApplicationContext</span><span class=o>();</span> <span class=c1>// 2.2.7
</span><span class=c1></span>    <span class=n>context</span><span class=o>.</span><span class=na>setApplicationStartup</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>applicationStartup</span><span class=o>);</span> <span class=c1>// 2.2.8
</span><span class=c1></span>    <span class=n>prepareContext</span><span class=o>(</span><span class=n>bootstrapContext</span><span class=o>,</span> <span class=n>context</span><span class=o>,</span> <span class=n>environment</span><span class=o>,</span> <span class=n>listeners</span><span class=o>,</span> <span class=n>applicationArguments</span><span class=o>,</span> <span class=n>printedBanner</span><span class=o>);</span> <span class=c1>//2.2.9
</span><span class=c1></span>    <span class=n>refreshContext</span><span class=o>(</span><span class=n>context</span><span class=o>);</span> <span class=c1>// 2.2.10
</span><span class=c1></span>    <span class=n>afterRefresh</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>applicationArguments</span><span class=o>);</span> <span class=c1>// 示例中为空
</span><span class=c1></span>    <span class=n>stopWatch</span><span class=o>.</span><span class=na>stop</span><span class=o>();</span> <span class=c1>// 停止计时器
</span><span class=c1></span>    <span class=c1>// 在控制台打印计时器的启动时间信息
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>logStartupInfo</span><span class=o>)</span> <span class=o>{</span>
      <span class=k>new</span> <span class=n>StartupInfoLogger</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>mainApplicationClass</span><span class=o>).</span><span class=na>logStarted</span><span class=o>(</span><span class=n>getApplicationLog</span><span class=o>(),</span> <span class=n>stopWatch</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=c1>// 通知对应的监听器，表明context已经启动,示例中ApplicationStartedEvent事件对应的监听器没有操作，只触发了AvailabilityChangeEvent事件，表明context正确运行，并在ApplicationAvailabilityBean的events属性中记录相应信息，状态：事件的AMP
</span><span class=c1></span>    <span class=n>listeners</span><span class=o>.</span><span class=na>started</span><span class=o>(</span><span class=n>context</span><span class=o>);</span> 
    <span class=n>callRunners</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>applicationArguments</span><span class=o>);</span> <span class=c1>// 示例中这一步为空。调用ApplicationRunner和CommandLineRunner类型的run方法
</span><span class=c1></span>  <span class=o>}</span>
  <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>handleRunFailure</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>ex</span><span class=o>,</span> <span class=n>listeners</span><span class=o>);</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
  <span class=o>}</span>

  <span class=k>try</span> <span class=o>{</span>
    <span class=n>listeners</span><span class=o>.</span><span class=na>running</span><span class=o>(</span><span class=n>context</span><span class=o>);</span> <span class=c1>//　通知对应的监听器，表明context已经在运行，跟前面的started类似，这里ApplicationReadyEvent事件对应的监听器没有操作，更新了context的状态ReadinessState.ACCEPTING_TRAFFIC
</span><span class=c1></span>  <span class=o>}</span>
  <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>handleRunFailure</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>ex</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
  <span class=o>}</span>
  <span class=k>return</span> <span class=n>context</span><span class=o>;</span> <span class=c1>// 2.2.11
</span><span class=c1></span><span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>方法的返回值是<code>ConfigurableApplicationContext</code>，也就是我们的spring容器，方法中的所有步骤都是为这个结果做准备的。上面不重要的步骤用注释带过，复杂点的分别说明。</p>
<h4 id=221-bootstrapcontext>2.2.1 bootstrapContext</h4>
<p>这个变量的类型是<code>DefaultBootstrapContext</code>，它跟<code>ApplicationContext</code>不是同一个分支，只是实现了<code>BootstrapRegistry</code>和<code>BootstrapContext</code>这两个接口，里面的功能很相对较少。</p>
<p>变量的值来自方法<code>createBootstrapContext()</code>，实现如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=n>DefaultBootstrapContext</span> <span class=nf>createBootstrapContext</span><span class=o>()</span> <span class=o>{</span>
  <span class=n>DefaultBootstrapContext</span> <span class=n>bootstrapContext</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultBootstrapContext</span><span class=o>();</span>
  <span class=k>this</span><span class=o>.</span><span class=na>bootstrapRegistryInitializers</span><span class=o>.</span><span class=na>forEach</span><span class=o>((</span><span class=n>initializer</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>initializer</span><span class=o>.</span><span class=na>initialize</span><span class=o>(</span><span class=n>bootstrapContext</span><span class=o>));</span>
  <span class=k>return</span> <span class=n>bootstrapContext</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个方法先是实例化一个<code>DefaultBootstrapContext</code>对象，然后再尝试用<a href=#2.1.2-bootstrapRegistryInitializers>2.1.2</a>描述过的<code>bootstrapRegistryInitializers</code>变量内的实现类去挨个的尝试初始化这个<code>context</code>，但是由前面的分析得知，变量是空的列表，所以这一步被跳过。</p>
<p>方法返回一个默认构造函数构造的<code>DefaultBootstrapContext</code>对象。</p>
<h4 id=222-configureheadlessproperty>2.2.2 configureHeadlessProperty()</h4>
<p>尝试设置系统属性<code>java.awt.headless</code>，从而打开headless模式。看方法代码：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=kt>void</span> <span class=nf>configureHeadlessProperty</span><span class=o>()</span> <span class=o>{</span>
  <span class=n>System</span><span class=o>.</span><span class=na>setProperty</span><span class=o>(</span><span class=n>SYSTEM_PROPERTY_JAVA_AWT_HEADLESS</span><span class=o>,</span>
      <span class=n>System</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=n>SYSTEM_PROPERTY_JAVA_AWT_HEADLESS</span><span class=o>,</span> <span class=n>Boolean</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>headless</span><span class=o>)));</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>SYSTEM_PROPERTY_JAVA_AWT_HEADLESS</code>是常量字符串<code>"java.awt.headless"</code>，<code>headless</code>的初始化值是<code>true</code>。</p>
<p>从上面的代码可以看出来，方法会首先从系统属性中获取<code>java.awt.headless</code>的值，如果已经被设置，就不会去覆盖，只有在没有设置的情况下才会设置成<code>true</code>。</p>
<p>为什么 spring boot 要设置headless模式呢？<br>
首先，headless模式的好处在于，如果你的代码需要调用图形界面，那么当运行这段代码的时候，就会直接抛出<code>java.awt.HeadlessException</code>这个异常，headless模式不允许代码去尝试调用图形界面相关功能。<br>
spring boot程序通常都运行在服务器上，服务器没有图形显示功能很正常。如果没有headless模式，可能我们的代码里出现了调用图形界面的情况，然后在PC上调试没有问题，打包到服务器运行的时候，服务器会尝试去调用图形界面功能，发现没有，然后报出相应的错误。</p>
<p>可以用docker模拟服务器环境，Dockerfile内容如下，放在jar包同目录：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=k>FROM</span><span class=s> openjdk:11.0.11-oracle</span><span class=err>
</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /</span><span class=err>
</span><span class=err></span><span class=k>ADD</span> demo-0.0.1-SNAPSHOT.jar demo.jar<span class=err>
</span><span class=err></span><span class=k>EXPOSE</span><span class=s> 8080</span><span class=err>
</span><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;java&#34;</span><span class=p>,</span> <span class=s2>&#34;-Djava.awt.headless=false&#34;</span><span class=p>,</span> <span class=s2>&#34;-jar&#34;</span><span class=p>,</span> <span class=s2>&#34;demo.jar&#34;</span><span class=p>]</span><span class=err>
</span></code></pre></td></tr></table>
</div>
</div><p><code>-Djava.awt.headless=false</code>这个参数可以在启动时（显然在spring boot前）设置<code>java.awt.headless</code>属性，避免被覆盖。</p>
<p>运行<code>docker build ./ -t demo</code>生成镜像，然后运行<code>docker run -p 8080:8080 demo</code>启动测试。</p>
<blockquote>
<p>PS:这里可以用JOptionPane.showMessageDialog(new Frame(),&ldquo;showMessage&rdquo;);这行代码去测试,它会弹出一个窗口,并且只有点击这个窗口的OK键程序才会继续执行(有时候弹出的窗口并没有在最顶层,用alt+tab键在所有窗口中找一下)。把这行代码分别放在SpringApplication.run(DemoApplication.class, args);之前，和放HelloController的return语句之前，也就是在spring 容器外和容器内分别测试，后者的报错信息量大且没有前者提示明显，也就是不开启headless模式更容易出现的情况。</p>
</blockquote>
<h4 id=223-listeners>2.2.3 listeners</h4>
<p>注意：这是<code>run</code>方法内的<strong>局部变量</strong>，虽然名称跟前面<code>SpringApplication</code>对象的字段一样(<a href=#2.1.4>2.1.4 setListeners</a>)</p>
<p>这里的<code>listeners</code>声明为<code>SpringApplicationRunListeners</code>类型，这个类型封装了一组<code>SpringApplicationRunListener</code>监听器(针对SpringApplication<code>run</code>方法的监听器)。</p>
<h5 id=223-1-声明并初始化listeners变量>2.2.3-1 声明并初始化listeners变量</h5>
<p><code>SpringApplicationRunListeners listeners = getRunListeners(args)</code><br>
用<code>getRunListeners</code>方法来初始化，方法实现如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=n>SpringApplicationRunListeners</span> <span class=nf>getRunListeners</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>types</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=o>{</span> <span class=n>SpringApplication</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>String</span><span class=o>[].</span><span class=na>class</span> <span class=o>};</span>
  <span class=k>return</span> <span class=k>new</span> <span class=n>SpringApplicationRunListeners</span><span class=o>(</span><span class=n>logger</span><span class=o>,</span>
      <span class=n>getSpringFactoriesInstances</span><span class=o>(</span><span class=n>SpringApplicationRunListener</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>types</span><span class=o>,</span> <span class=k>this</span><span class=o>,</span> <span class=n>args</span><span class=o>),</span>
      <span class=k>this</span><span class=o>.</span><span class=na>applicationStartup</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>实际上就是调用构造函数，<code>logger</code>是在<code>SpringApplication</code>进于类初始化的时候设置好的字段: <code>private static final Log logger = LogFactory.getLog(SpringApplication.class);</code>，日志主要是记录失败相关的信息</p>
<p><code>getSpringFactoriesInstances</code>方法中的参数是为了匹配类的构造函数，<span id=2.2.3-1-listenerimpl>这里只有一个监听器实现类</span><code>org.springframework.boot.context.event.EventPublishingRunListener</code>,匹配到<code>public EventPublishingRunListener(SpringApplication application, String[] args)</code>这个构造函数进行实例化</p>
<h5 id=223-2-listenersstartingbootstrapcontext-thismainapplicationclass>2.2.3-2 listeners.starting(bootstrapContext, this.mainApplicationClass)</h5>
<p>调用<code>SpringApplicationRunListeners</code>的<code>starting</code>方法：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kt>void</span> <span class=nf>starting</span><span class=o>(</span><span class=n>ConfigurableBootstrapContext</span> <span class=n>bootstrapContext</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>mainApplicationClass</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>doWithListeners</span><span class=o>(</span><span class=s>&#34;spring.boot.application.starting&#34;</span><span class=o>,</span> <span class=o>(</span><span class=n>listener</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>listener</span><span class=o>.</span><span class=na>starting</span><span class=o>(</span><span class=n>bootstrapContext</span><span class=o>),</span>
      <span class=o>(</span><span class=n>step</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>mainApplicationClass</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
          <span class=n>step</span><span class=o>.</span><span class=na>tag</span><span class=o>(</span><span class=s>&#34;mainApplicationClass&#34;</span><span class=o>,</span> <span class=n>mainApplicationClass</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
        <span class=o>}</span>
      <span class=o>});</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>doWithListeners</code>会遍历每一个<code>SpringApplicationRunListeners</code>的实现类，调用其<code>starting</code>方法，
<a href=#2.2.3-1-listenerimpl>上面</a>提到只有一个实现类<code>EventPublishingRunListener</code>，它的<code>starting</code>方法如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kt>void</span> <span class=nf>starting</span><span class=o>(</span><span class=n>ConfigurableBootstrapContext</span> <span class=n>bootstrapContext</span><span class=o>)</span> <span class=o>{</span>
  <span class=k>this</span><span class=o>.</span><span class=na>initialMulticaster</span>
      <span class=o>.</span><span class=na>multicastEvent</span><span class=o>(</span><span class=k>new</span> <span class=n>ApplicationStartingEvent</span><span class=o>(</span><span class=n>bootstrapContext</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>application</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>args</span><span class=o>));</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>initialMulticaster.multicastEvent</code>的作用就是把<code>ApplicationStartingEvent</code>这个启动事件传播给所有的支持这个事件的监听器，这些监听器是从<a href=#2.1.4>前面</a><code>SpringApplication</code>实例化时得到的9个监听器中筛选出来的(筛选过程就是判断监听器是否支持事件本身以及其source的类型)，筛选后的监听器会去判断自身是否含有处理这个事件的代码，如果有，则执行相应的逻辑，在这个例子中只有<code>org.springframework.boot.context.logging.LoggingApplicationListener</code>有相应的逻辑。</p>
<h4 id=224-applicationarguments-applicationarguments--new-defaultapplicationargumentsargs>2.2.4 ApplicationArguments applicationArguments = new DefaultApplicationArguments(args)</h4>
<p>把<code>args</code>参数包装在<code>ApplicationArguments</code>里面，这里args的值是空的Sttring[]</p>
<h4 id=225-prepareenvironment>2.2.5 prepareEnvironment</h4>
<p><code>ConfigurableEnvironment environment = prepareEnvironment(listeners, bootstrapContext, applicationArguments)</code></p>
<p>3个参数在前面都介绍过，看一下方法主体：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=n>ConfigurableEnvironment</span> <span class=nf>prepareEnvironment</span><span class=o>(</span><span class=n>SpringApplicationRunListeners</span> <span class=n>listeners</span><span class=o>,</span>
    <span class=n>DefaultBootstrapContext</span> <span class=n>bootstrapContext</span><span class=o>,</span> <span class=n>ApplicationArguments</span> <span class=n>applicationArguments</span><span class=o>)</span> <span class=o>{</span>
  <span class=c1>// Create and configure the environment
</span><span class=c1></span>  <span class=n>ConfigurableEnvironment</span> <span class=n>environment</span> <span class=o>=</span> <span class=n>getOrCreateEnvironment</span><span class=o>();</span>
  <span class=n>configureEnvironment</span><span class=o>(</span><span class=n>environment</span><span class=o>,</span> <span class=n>applicationArguments</span><span class=o>.</span><span class=na>getSourceArgs</span><span class=o>());</span>
  <span class=n>ConfigurationPropertySources</span><span class=o>.</span><span class=na>attach</span><span class=o>(</span><span class=n>environment</span><span class=o>);</span>

  <span class=n>listeners</span><span class=o>.</span><span class=na>environmentPrepared</span><span class=o>(</span><span class=n>bootstrapContext</span><span class=o>,</span> <span class=n>environment</span><span class=o>);</span>

  <span class=n>DefaultPropertiesPropertySource</span><span class=o>.</span><span class=na>moveToEnd</span><span class=o>(</span><span class=n>environment</span><span class=o>);</span><span class=c1>//尝试移动defaultproperties,我们这里是null,所以无操作
</span><span class=c1></span>
  <span class=n>configureAdditionalProfiles</span><span class=o>(</span><span class=n>environment</span><span class=o>);</span><span class=c1>//配置additionalProfiles，这里是空的集合，所以无操作
</span><span class=c1></span>
  <span class=n>bindToSpringApplication</span><span class=o>(</span><span class=n>environment</span><span class=o>);</span>

  <span class=c1>// 确保enviroment类型正确
</span><span class=c1></span>  <span class=k>if</span> <span class=o>(!</span><span class=k>this</span><span class=o>.</span><span class=na>isCustomEnvironment</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>environment</span> <span class=o>=</span> <span class=k>new</span> <span class=n>EnvironmentConverter</span><span class=o>(</span><span class=n>getClassLoader</span><span class=o>()).</span><span class=na>convertEnvironmentIfNecessary</span><span class=o>(</span><span class=n>environment</span><span class=o>,</span>
        <span class=n>deduceEnvironmentClass</span><span class=o>());</span>
  <span class=o>}</span>

  <span class=c1>//从上一次attach之后，enviroment中的propertysources已经发生变化，这里重新attach一次
</span><span class=c1></span>  <span class=n>ConfigurationPropertySources</span><span class=o>.</span><span class=na>attach</span><span class=o>(</span><span class=n>environment</span><span class=o>);</span>
  <span class=k>return</span> <span class=n>environment</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>先初始化一个<code>enviroment</code>对象，<code>getOrCreateEnvironment</code>会根据<a href=#2.1.1>前面的webApplicationType</a>来获取一个初始值，我们的例子中是<code>new StandardServletEnvironment()</code>，在实例化这个对象的过程中，它会调用祖先类<code>AbstractEnvironment</code>的构造函数来执行自身的<code>customizePropertySources</code>方法，从而设置几个<code>PropertySource</code></p>
<p>然后调用<code>configureEnvironment</code>方法，这一步主要是给<code>enviroment</code>设置<code>conversionService</code>，祖先类<code>AbstractEnvironment</code>的构造函数中初始化了一个字段<code>propertyResolver</code>，类型是<code>PropertySourcesPropertyResolver</code>，<code>conversionService</code>就是设置在<code>propertyResolver</code>上的</p>
<p><code>attach</code>方法把<code>enviroment</code>里面的<code>propertysource</code>封装到<code>ConfigurationPropertySourcesPropertySource</code>内，并把封装后的元素添加到<code>propertysource</code>的第1个位置，看下面这行代码：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>sources</span><span class=o>.</span><span class=na>addFirst</span><span class=o>(</span><span class=k>new</span> <span class=n>ConfigurationPropertySourcesPropertySource</span><span class=o>(</span><span class=n>ATTACHED_PROPERTY_SOURCE_NAME</span><span class=o>,</span>
    <span class=k>new</span> <span class=n>SpringConfigurationPropertySources</span><span class=o>(</span><span class=n>sources</span><span class=o>)));</span>
</code></pre></td></tr></table>
</div>
</div><p>被封装的<code>sources</code>是一个引用对象，也就是说，当<code>sources.addFirst</code>这个操作完成后，被封装的<code>sources</code>也发生了变化，<code>sources</code>可以在自身包含的元素中看到对自身的引用，如果在调试时查看<code>source</code>内容，可以"无限展开"，如下图：</p>
<details>
<summary>显示图片</summary>
<p><img src=propertysource.png alt=图片 title=循环引用的sources></p>
</details>
<p><code>listeners.environmentPrepared(bootstrapContext, environment);</code><span id=prepareenv>&ldquo;这一行</span>触发事件environmentPrepared，通知所有符合条件的监听器执行操作，spring boot的<code>application.properties</code>配置文件就是在这时候被读取并解析的，在<code>org.springframework.boot.env.PropertiesPropertySourceLoader</code>这个类的<code>load</code>方法打个断点，就能反向的看到整个过程。</p>
<p><code>bindToSpringApplication(environment);</code>把配置文件中的<code>spring.main</code>前缀的属性绑定到<code>SpringApplication</code>实例（配置文件中的信息已经在<a href=#prepareenv>上一步</a>操作中绑定到了enviroment变量中），比如我们在<code>application.properties</code>配置文件中设置了<code>spring.main.banner-mode=off</code>（默认值是console)，在bind这一步完成后，值就变成了off。<code>spring.main</code>对应的都是<code>SpringApplication</code>中的字段(但不是所有字段都开放修改），可以在配置文件中覆盖默认值。</p>
<h4 id=226-configureignorebeaninfoenvironment>2.2.6 configureIgnoreBeanInfo(environment)</h4>
<p>设置<code>spring.beaninfo.ignore</code>这个系统变量的值，如果之前已经设置，则跳过，如果没有设置，则设为<code>true</code></p>
<h4 id=227-createapplicationcontext>2.2.7 createApplicationContext()</h4>
<p>给context赋值,根据<code>webApplicationType</code>的值返回对应的实例，我们的例子是<code>SERVLET</code>，返回<code>new AnnotationConfigServletWebServerApplicationContext()</code>，相当于一个基准容器。</p>
<blockquote>
<p>这个方法调用的是<code>ApplicationContextFactory</code>的<code>create</code>方法，而实现<code>ApplicationContextFactory</code>接口的实例<code>DEFAULT</code>是通过lambda表达式给出的。</p>
</blockquote>
<h4 id=228-contextsetapplicationstartupthisapplicationstartup>2.2.8 context.setApplicationStartup(this.applicationStartup)</h4>
<p>设置<code>applicationStartup</code>这个字段，值是<code>ApplicationStartup.DEFAULT</code>，这里调用的是当前<code>context</code>的祖先类<code>GenericApplicationContext</code>里的<code>setApplicationStartup</code>方法，如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setApplicationStartup</span><span class=o>(</span><span class=n>ApplicationStartup</span> <span class=n>applicationStartup</span><span class=o>)</span> <span class=o>{</span>
  <span class=kd>super</span><span class=o>.</span><span class=na>setApplicationStartup</span><span class=o>(</span><span class=n>applicationStartup</span><span class=o>);</span>
  <span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span><span class=o>.</span><span class=na>setApplicationStartup</span><span class=o>(</span><span class=n>applicationStartup</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>分两步，首先设置它的父类<code>AbstractApplicationContext</code>的字段<code>applicationStartup</code>，然后设置它的字段<code>beanFactory</code>内的字段<code>applicationStartup</code>，<code>beanFactory</code>的类型是<code>DefaultListableBeanFactory</code>,实际上这两处设置的字段，本身的初始化值就是<code>ApplicationStartup.DEFAULT</code>。</p>
<h4 id=229-preparecontext>2.2.9 prepareContext</h4>
<p>传入前面设置好的多个变量，给容器作调整，方法如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=kt>void</span> <span class=nf>prepareContext</span><span class=o>(</span><span class=n>DefaultBootstrapContext</span> <span class=n>bootstrapContext</span><span class=o>,</span> <span class=n>ConfigurableApplicationContext</span> <span class=n>context</span><span class=o>,</span><span class=n>ConfigurableEnvironment</span> <span class=n>environment</span><span class=o>,</span> <span class=n>SpringApplicationRunListeners</span> <span class=n>listeners</span><span class=o>,</span>
<span class=n>ApplicationArguments</span> <span class=n>applicationArguments</span><span class=o>,</span> <span class=n>Banner</span> <span class=n>printedBanner</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>context</span><span class=o>.</span><span class=na>setEnvironment</span><span class=o>(</span><span class=n>environment</span><span class=o>);</span>
  <span class=n>postProcessApplicationContext</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
  <span class=n>applyInitializers</span><span class=o>(</span><span class=n>context</span><span class=o>);</span>
  <span class=n>listeners</span><span class=o>.</span><span class=na>contextPrepared</span><span class=o>(</span><span class=n>context</span><span class=o>);</span> <span class=c1>// 触发contextPrepared事件，让对应的监听器处理，这里有两个监听器符合条件，但无处理操作
</span><span class=c1></span>
  <span class=n>bootstrapContext</span><span class=o>.</span><span class=na>close</span><span class=o>(</span><span class=n>context</span><span class=o>);</span> <span class=c1>// 关闭bootstrapContext并触发相关事件，此处无对应监听器
</span><span class=c1></span>
  <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>logStartupInfo</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// 是否打印启动信息
</span><span class=c1></span>    <span class=n>logStartupInfo</span><span class=o>(</span><span class=n>context</span><span class=o>.</span><span class=na>getParent</span><span class=o>()</span> <span class=o>==</span> <span class=kc>null</span><span class=o>);</span> <span class=c1>// 对应启动信息里的第一行
</span><span class=c1></span>    <span class=n>logStartupProfileInfo</span><span class=o>(</span><span class=n>context</span><span class=o>);</span> <span class=c1>// // 对应启动信息里的第f二行
</span><span class=c1></span>  <span class=o>}</span>

  <span class=c1>// Add boot specific singleton beans
</span><span class=c1></span>  <span class=n>ConfigurableListableBeanFactory</span> <span class=n>beanFactory</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getBeanFactory</span><span class=o>();</span> <span class=c1>// 获取beanfactory，值是`new DefaultListableBeanFactory()`
</span><span class=c1></span>  <span class=n>beanFactory</span><span class=o>.</span><span class=na>registerSingleton</span><span class=o>(</span><span class=s>&#34;springApplicationArguments&#34;</span><span class=o>,</span> <span class=n>applicationArguments</span><span class=o>);</span> <span class=c1>//注册applicationArguments
</span><span class=c1></span>
  <span class=k>if</span> <span class=o>(</span><span class=n>printedBanner</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span> <span class=c1>//如果application.properties里设置了spring.main.banner-mode=off，这里就跳过
</span><span class=c1></span>    <span class=n>beanFactory</span><span class=o>.</span><span class=na>registerSingleton</span><span class=o>(</span><span class=s>&#34;springBootBanner&#34;</span><span class=o>,</span> <span class=n>printedBanner</span><span class=o>);</span> <span class=c1>// 注册Banner
</span><span class=c1></span>  <span class=o>}</span>

  <span class=k>if</span> <span class=o>(</span><span class=n>beanFactory</span> <span class=k>instanceof</span> <span class=n>DefaultListableBeanFactory</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// true
</span><span class=c1></span>
    <span class=c1>// 给beanFactory设置是否允许BeanDefinitionOverriding,值是false
</span><span class=c1></span>    <span class=o>((</span><span class=n>DefaultListableBeanFactory</span><span class=o>)</span> <span class=n>beanFactory</span><span class=o>)</span>
        <span class=o>.</span><span class=na>setAllowBeanDefinitionOverriding</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>allowBeanDefinitionOverriding</span><span class=o>);</span>
  <span class=o>}</span>
  <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>lazyInitialization</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// false
</span><span class=c1></span>    <span class=n>context</span><span class=o>.</span><span class=na>addBeanFactoryPostProcessor</span><span class=o>(</span><span class=k>new</span> <span class=n>LazyInitializationBeanFactoryPostProcessor</span><span class=o>());</span>
  <span class=o>}</span>
  <span class=c1>// Load the sources
</span><span class=c1></span>  <span class=n>Set</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>sources</span> <span class=o>=</span> <span class=n>getAllSources</span><span class=o>();</span>
  <span class=n>Assert</span><span class=o>.</span><span class=na>notEmpty</span><span class=o>(</span><span class=n>sources</span><span class=o>,</span> <span class=s>&#34;Sources must not be empty&#34;</span><span class=o>);</span> <span class=c1>// 检查sources不为空
</span><span class=c1></span>  <span class=n>load</span><span class=o>(</span><span class=n>context</span><span class=o>,</span> <span class=n>sources</span><span class=o>.</span><span class=na>toArray</span><span class=o>(</span><span class=k>new</span> <span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]));</span> 
  <span class=n>listeners</span><span class=o>.</span><span class=na>contextLoaded</span><span class=o>(</span><span class=n>context</span><span class=o>);</span> 
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>context.setEnvironment(environment)</code>：把环境变量设置到context的对应字段上，分别是其祖先类<code>AbstractApplication</code>的<code>enviroment</code>字段，及<code>reader</code>和<code>scanner</code>的相关字段</p>
</li>
<li>
<p><code>postProcessApplicationContext(context)</code>：对<code>context</code>作一些补充设置，判断<code>beanNameGenerator</code>，<code>resourceLoader</code>，<code>addConversionService</code>这3个字段是否被设置，如果是，则对<code>context</code>作相应的设置，这里前面2个都是Null，第3个设置到<code>context</code>的祖先类<code>AbstractBeanFactory</code>的字段上</p>
</li>
<li>
<p><code>applyInitializers(context)</code>:用<a href=#2.1.3>2.1.3</a>设置的<code>initializer</code>挨个对<code>context</code>执行初始化。</p>
</li>
<li>
<p><code>Set&lt;Object> sources = getAllSources()</code>：获取<code>this.primarySource</code>(见<a href=#2.1>2.1</a>,值是<code>com.example.demo.DemoApplication.class</code>)和<code>this.sources</code>的值（空集合）</p>
</li>
<li>
<p><code>load(context, sources.toArray(new Object[0]))</code>:把主启动类注册到<code>context</code></p>
</li>
<li>
<p><code>listeners.contextLoaded(context)</code>：发出contextLoaded事件，在EventPublishingRunListener中用ApplicationPreparedEvent包装。主要是<code>LoggingApplicationListener</code>注册了两个<code>log</code>相关的<code>singletonbean</code>，及<code>EnvironmentPostProcessorApplicationListener</code>对<code>log</code>进行一些处理。</p>
</li>
</ul>
<h4 id=2210-refreshcontext>2.2.10 refreshContext</h4>
<p>首先确保<code>registerShutdownHook</code>存在，不存在的话创建一个。这个勾子函数的作用是在JVM关闭的时候，先关闭context，但是如果JVM是非正常退出，比如被系统中止进程，内存访问出错等，那勾子函数不一定生效。</p>
<p>实现的方法在<code>AbstractApplicationContext</code>的<code>refresh</code>，如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>refresh</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>BeansException</span><span class=o>,</span> <span class=n>IllegalStateException</span> <span class=o>{</span>
  <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>startupShutdownMonitor</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>StartupStep</span> <span class=n>contextRefresh</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>applicationStartup</span><span class=o>.</span><span class=na>start</span><span class=o>(</span><span class=s>&#34;spring.context.refresh&#34;</span><span class=o>);</span>

    <span class=c1>// Prepare this context for refreshing.
</span><span class=c1></span>    <span class=n>prepareRefresh</span><span class=o>();</span> <span class=c1>// 初始化一些属性，判断this.earlyApplicationListeners是否有值，有的话把这些值传入this.applicationListeners（先清空），如果没有，则反过来，把this.applicationListeners的值传给this.earlyApplicationListeners
</span><span class=c1></span>
    <span class=c1>// Tell the subclass to refresh the internal bean factory.
</span><span class=c1></span>    <span class=n>ConfigurableListableBeanFactory</span> <span class=n>beanFactory</span> <span class=o>=</span> <span class=n>obtainFreshBeanFactory</span><span class=o>();</span> <span class=c1>// 获取beanFactory,类型是DefaultListableBeanFactory，设置了serializableId=application
</span><span class=c1></span>
    <span class=c1>// Prepare the bean factory for use in this context.
</span><span class=c1></span>    <span class=n>prepareBeanFactory</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>);</span>

    <span class=k>try</span> <span class=o>{</span>

      <span class=c1>// 添加一个WebApplicationContextServletContextAwareProcessor类型的postProcessor，及把ServletContextAware.class接口添加到ignoreDependencyInterface列表内
</span><span class=c1></span>      <span class=c1>// Allows post-processing of the bean factory in context subclasses.
</span><span class=c1></span>      <span class=n>postProcessBeanFactory</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>);</span>

      <span class=c1>// 启动一个步骤，步骤可以记录它开始到结束的数据，或者步骤耗时等，这里用处不大
</span><span class=c1></span>      <span class=n>StartupStep</span> <span class=n>beanPostProcess</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>applicationStartup</span><span class=o>.</span><span class=na>start</span><span class=o>(</span><span class=s>&#34;spring.context.beans.post-process&#34;</span><span class=o>);</span>
      
      <span class=c1>// Invoke factory processors registered as beans in the context.
</span><span class=c1></span>      <span class=n>invokeBeanFactoryPostProcessors</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>);</span>

      <span class=c1>// Register bean processors that intercept bean creation.
</span><span class=c1></span>      <span class=n>registerBeanPostProcessors</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>);</span>
      <span class=c1>// 结束步骤
</span><span class=c1></span>      <span class=n>beanPostProcess</span><span class=o>.</span><span class=na>end</span><span class=o>();</span>

      <span class=c1>// Initialize message source for this context.
</span><span class=c1></span>      <span class=c1>// 初始化MessageSource,这里是空，并且步骤中会记录trace级别的log，如果在application.properties中开启的话，就可以看到
</span><span class=c1></span>      <span class=n>initMessageSource</span><span class=o>();</span>

      <span class=c1>// Initialize event multicaster for this context.
</span><span class=c1></span>      <span class=c1>// 初始化applicationEventMulticaster属性，示例中用的是SimpleApplicationEventMulticaster类型
</span><span class=c1></span>      <span class=n>initApplicationEventMulticaster</span><span class=o>();</span>

      <span class=c1>// Initialize other special beans in specific context subclasses.
</span><span class=c1></span>      <span class=c1>// 启动内嵌的tomcat容器，console输出相关5条INFO级别信息
</span><span class=c1></span>      <span class=n>onRefresh</span><span class=o>();</span>

      <span class=c1>// Check for listener beans and register them.
</span><span class=c1></span>      <span class=c1>// 找到context中直接存在的listener以及bean中属于ApplicationListener类型的bean，注册到ApplicationEventMulticaster中(示例实现类是SimpleApplicationEventMulticaster)
</span><span class=c1></span>      <span class=n>registerListeners</span><span class=o>();</span>

      <span class=c1>// Instantiate all remaining (non-lazy-init) singletons.
</span><span class=c1></span>      <span class=n>finishBeanFactoryInitialization</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>);</span>

      <span class=c1>// Last step: publish corresponding event.
</span><span class=c1></span>      <span class=n>finishRefresh</span><span class=o>();</span>
    <span class=o>}</span>

    <span class=k>catch</span> <span class=o>(</span><span class=n>BeansException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
      <span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isWarnEnabled</span><span class=o>())</span> <span class=o>{</span>
        <span class=n>logger</span><span class=o>.</span><span class=na>warn</span><span class=o>(</span><span class=s>&#34;Exception encountered during context initialization - &#34;</span> <span class=o>+</span>
            <span class=s>&#34;cancelling refresh attempt: &#34;</span> <span class=o>+</span> <span class=n>ex</span><span class=o>);</span>
      <span class=o>}</span>

      <span class=c1>// Destroy already created singletons to avoid dangling resources.
</span><span class=c1></span>      <span class=n>destroyBeans</span><span class=o>();</span>

      <span class=c1>// Reset &#39;active&#39; flag.
</span><span class=c1></span>      <span class=n>cancelRefresh</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>

      <span class=c1>// Propagate exception to caller.
</span><span class=c1></span>      <span class=k>throw</span> <span class=n>ex</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=k>finally</span> <span class=o>{</span>
      <span class=c1>// Reset common introspection caches in Spring&#39;s core, since we
</span><span class=c1></span>      <span class=c1>// might not ever need metadata for singleton beans anymore...
</span><span class=c1></span>      <span class=n>resetCommonCaches</span><span class=o>();</span>
      <span class=n>contextRefresh</span><span class=o>.</span><span class=na>end</span><span class=o>();</span>
    <span class=o>}</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>prepareBeanFactory</code>:对<code>beanFactory</code>进行各种设置，方法如下，用注释说明。</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>prepareBeanFactory</span><span class=o>(</span><span class=n>ConfigurableListableBeanFactory</span> <span class=n>beanFactory</span><span class=o>)</span> <span class=o>{</span>
  <span class=c1>// Tell the internal bean factory to use the context&#39;s class loader etc.
</span><span class=c1></span>  <span class=n>beanFactory</span><span class=o>.</span><span class=na>setBeanClassLoader</span><span class=o>(</span><span class=n>getClassLoader</span><span class=o>());</span>

  <span class=k>if</span> <span class=o>(!</span><span class=n>shouldIgnoreSpel</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// 是否忽略SpEL(Spring Expression Language)，这里是不忽略，所以设置相应的解析器
</span><span class=c1></span>    <span class=n>beanFactory</span><span class=o>.</span><span class=na>setBeanExpressionResolver</span><span class=o>(</span><span class=k>new</span> <span class=n>StandardBeanExpressionResolver</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>getBeanClassLoader</span><span class=o>()));</span>
  <span class=o>}</span>

  <span class=c1>// 添加一个propertyEditor的注册器，用来注册各种editor
</span><span class=c1></span>  <span class=n>beanFactory</span><span class=o>.</span><span class=na>addPropertyEditorRegistrar</span><span class=o>(</span><span class=k>new</span> <span class=n>ResourceEditorRegistrar</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>getEnvironment</span><span class=o>()));</span>

  <span class=c1>// Configure the bean factory with context callbacks.
</span><span class=c1></span>  <span class=n>beanFactory</span><span class=o>.</span><span class=na>addBeanPostProcessor</span><span class=o>(</span><span class=k>new</span> <span class=n>ApplicationContextAwareProcessor</span><span class=o>(</span><span class=k>this</span><span class=o>));</span> <span class=c1>// 添加一个beanPostProcessor，类型是ApplicationContextAwareProcessor，如果原先存在，则先删除再添加，添加在AbstractBeanFactory的beanPostProcessors属性上
</span><span class=c1></span>
  <span class=c1>// 添加下面的几个类到ignoredDependencyInterfaces属性（从DefaultListableBeanFactory的父类AbstractAutowireCapableBeanFactory中继承），后面的一些操作会根据这个set属性中的接口来判断是否要过滤相应的属性（判断属性的setter方法是否源于实现相应的接口方法）
</span><span class=c1></span>  <span class=c1>// BeanFactoryAware.class是默认添加的
</span><span class=c1></span>  <span class=n>beanFactory</span><span class=o>.</span><span class=na>ignoreDependencyInterface</span><span class=o>(</span><span class=n>EnvironmentAware</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
  <span class=n>beanFactory</span><span class=o>.</span><span class=na>ignoreDependencyInterface</span><span class=o>(</span><span class=n>EmbeddedValueResolverAware</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
  <span class=n>beanFactory</span><span class=o>.</span><span class=na>ignoreDependencyInterface</span><span class=o>(</span><span class=n>ResourceLoaderAware</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
  <span class=n>beanFactory</span><span class=o>.</span><span class=na>ignoreDependencyInterface</span><span class=o>(</span><span class=n>ApplicationEventPublisherAware</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
  <span class=n>beanFactory</span><span class=o>.</span><span class=na>ignoreDependencyInterface</span><span class=o>(</span><span class=n>MessageSourceAware</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
  <span class=n>beanFactory</span><span class=o>.</span><span class=na>ignoreDependencyInterface</span><span class=o>(</span><span class=n>ApplicationContextAware</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
  <span class=n>beanFactory</span><span class=o>.</span><span class=na>ignoreDependencyInterface</span><span class=o>(</span><span class=n>ApplicationStartupAware</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>

  <span class=c1>// 这一步类似于手动装配，第1个参数是类型，第2个参数是这个类型返回的实例，如果第2个参数实现了第1个参数的子接口，那么这个子接口也会被装配
</span><span class=c1></span>  <span class=c1>// BeanFactory interface not registered as resolvable type in a plain factory.
</span><span class=c1></span>  <span class=c1>// MessageSource registered (and found for autowiring) as a bean.
</span><span class=c1></span>  <span class=n>beanFactory</span><span class=o>.</span><span class=na>registerResolvableDependency</span><span class=o>(</span><span class=n>BeanFactory</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>);</span>
  <span class=n>beanFactory</span><span class=o>.</span><span class=na>registerResolvableDependency</span><span class=o>(</span><span class=n>ResourceLoader</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
  <span class=n>beanFactory</span><span class=o>.</span><span class=na>registerResolvableDependency</span><span class=o>(</span><span class=n>ApplicationEventPublisher</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
  <span class=n>beanFactory</span><span class=o>.</span><span class=na>registerResolvableDependency</span><span class=o>(</span><span class=n>ApplicationContext</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>

  <span class=c1>// 添加一个针对ApplictionListener后处器
</span><span class=c1></span>  <span class=c1>// Register early post-processor for detecting inner beans as ApplicationListeners.
</span><span class=c1></span>  <span class=n>beanFactory</span><span class=o>.</span><span class=na>addBeanPostProcessor</span><span class=o>(</span><span class=k>new</span> <span class=n>ApplicationListenerDetector</span><span class=o>(</span><span class=k>this</span><span class=o>));</span>

  <span class=c1>// 跳过，loadTimeWeaver在JVM加载类之前通过transformer对类其进行处理，这里没有这个bean
</span><span class=c1></span>  <span class=c1>// Detect a LoadTimeWeaver and prepare for weaving, if found.
</span><span class=c1></span>  <span class=k>if</span> <span class=o>(!</span><span class=n>NativeDetector</span><span class=o>.</span><span class=na>inNativeImage</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>beanFactory</span><span class=o>.</span><span class=na>containsBean</span><span class=o>(</span><span class=n>LOAD_TIME_WEAVER_BEAN_NAME</span><span class=o>))</span> <span class=o>{</span>
    <span class=n>beanFactory</span><span class=o>.</span><span class=na>addBeanPostProcessor</span><span class=o>(</span><span class=k>new</span> <span class=n>LoadTimeWeaverAwareProcessor</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>));</span>
    <span class=c1>// Set a temporary ClassLoader for type matching.
</span><span class=c1></span>    <span class=n>beanFactory</span><span class=o>.</span><span class=na>setTempClassLoader</span><span class=o>(</span><span class=k>new</span> <span class=n>ContextTypeMatchClassLoader</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>getBeanClassLoader</span><span class=o>()));</span>
  <span class=o>}</span>

  <span class=c1>// 确保下面几个类型的bean都注册了，如果没注册，就设置为当前context相关的实例
</span><span class=c1></span>  <span class=c1>// Register default environment beans.
</span><span class=c1></span>  <span class=k>if</span> <span class=o>(!</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>containsLocalBean</span><span class=o>(</span><span class=n>ENVIRONMENT_BEAN_NAME</span><span class=o>))</span> <span class=o>{</span>
    <span class=n>beanFactory</span><span class=o>.</span><span class=na>registerSingleton</span><span class=o>(</span><span class=n>ENVIRONMENT_BEAN_NAME</span><span class=o>,</span> <span class=n>getEnvironment</span><span class=o>());</span>
  <span class=o>}</span>
  <span class=k>if</span> <span class=o>(!</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>containsLocalBean</span><span class=o>(</span><span class=n>SYSTEM_PROPERTIES_BEAN_NAME</span><span class=o>))</span> <span class=o>{</span>
    <span class=n>beanFactory</span><span class=o>.</span><span class=na>registerSingleton</span><span class=o>(</span><span class=n>SYSTEM_PROPERTIES_BEAN_NAME</span><span class=o>,</span> <span class=n>getEnvironment</span><span class=o>().</span><span class=na>getSystemProperties</span><span class=o>());</span>
  <span class=o>}</span>
  <span class=k>if</span> <span class=o>(!</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>containsLocalBean</span><span class=o>(</span><span class=n>SYSTEM_ENVIRONMENT_BEAN_NAME</span><span class=o>))</span> <span class=o>{</span>
    <span class=n>beanFactory</span><span class=o>.</span><span class=na>registerSingleton</span><span class=o>(</span><span class=n>SYSTEM_ENVIRONMENT_BEAN_NAME</span><span class=o>,</span> <span class=n>getEnvironment</span><span class=o>().</span><span class=na>getSystemEnvironment</span><span class=o>());</span>
  <span class=o>}</span>
  <span class=k>if</span> <span class=o>(!</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>containsLocalBean</span><span class=o>(</span><span class=n>APPLICATION_STARTUP_BEAN_NAME</span><span class=o>))</span> <span class=o>{</span>
    <span class=n>beanFactory</span><span class=o>.</span><span class=na>registerSingleton</span><span class=o>(</span><span class=n>APPLICATION_STARTUP_BEAN_NAME</span><span class=o>,</span> <span class=n>getApplicationStartup</span><span class=o>());</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>invokeBeanFactoryPostProcessors(beanFactory):从<code>context</code>中获取<code>beanFactoryPostProcessors</code>对当前的<code>beanFactory</code>进行处理，实现这个功能的方法是<code>PostProcessorRegistrationDelegate</code>的<code>invokeBeanFactoryPostProcessors</code>，方法内容很多，方法中涉及的内容只用注释说明，不再继续展开，方法如下：</li>
</ul>
<details>
<summary>展开内容</summary>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>invokeBeanFactoryPostProcessors</span><span class=o>(</span>
			<span class=n>ConfigurableListableBeanFactory</span> <span class=n>beanFactory</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>BeanFactoryPostProcessor</span><span class=o>&gt;</span> <span class=n>beanFactoryPostProcessors</span><span class=o>)</span> <span class=o>{</span>

		<span class=c1>// Invoke BeanDefinitionRegistryPostProcessors first, if any.
</span><span class=c1></span>		<span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>processedBeans</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;&gt;();</span>

		<span class=k>if</span> <span class=o>(</span><span class=n>beanFactory</span> <span class=k>instanceof</span> <span class=n>BeanDefinitionRegistry</span><span class=o>)</span> <span class=o>{</span>
			<span class=n>BeanDefinitionRegistry</span> <span class=n>registry</span> <span class=o>=</span> <span class=o>(</span><span class=n>BeanDefinitionRegistry</span><span class=o>)</span> <span class=n>beanFactory</span><span class=o>;</span>
			<span class=n>List</span><span class=o>&lt;</span><span class=n>BeanFactoryPostProcessor</span><span class=o>&gt;</span> <span class=n>regularPostProcessors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
			<span class=n>List</span><span class=o>&lt;</span><span class=n>BeanDefinitionRegistryPostProcessor</span><span class=o>&gt;</span> <span class=n>registryProcessors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>

     <span class=c1>// 先对beanFactory这个bean自身的definition的注册进行处理
</span><span class=c1></span>     <span class=c1>// 在我们的例子中有两个`beanFactoryPostProcessor`,都是嵌套类，分别是
</span><span class=c1></span>     <span class=c1>// `SharedMetadataReaderFactoryContextInitializer.CachingMetadataReaderFactoryPostProcessor`
</span><span class=c1></span>     <span class=c1>// 和`ConfigurationWarningsApplicationContextInitializer.ComponentScanPackageCheck`,
</span><span class=c1></span>     <span class=c1>// 第1个给名字为`org.springframework.context.annotation.internalConfigurationAnnotationProcessor`
</span><span class=c1></span>     <span class=c1>// 的`beanDefination`(对应的`Class`是`ConfigurationClassPostProcessor`)添加一个`propertyValue`，键值对是`metadataReaderFactory`：
</span><span class=c1></span>     <span class=c1>// `&lt;org.springframework.boot.autoconfigure.internalCachingMetadataReaderFactory&gt;`。
</span><span class=c1></span>     <span class=c1>// 第2个扫描所有的`beanDefinition`，判断`@ComponentScan`注解是否可以正常运行。
</span><span class=c1></span>			<span class=k>for</span> <span class=o>(</span><span class=n>BeanFactoryPostProcessor</span> <span class=n>postProcessor</span> <span class=o>:</span> <span class=n>beanFactoryPostProcessors</span><span class=o>)</span> <span class=o>{</span>
        <span class=c1>// 这一步两个都是
</span><span class=c1></span>				<span class=k>if</span> <span class=o>(</span><span class=n>postProcessor</span> <span class=k>instanceof</span> <span class=n>BeanDefinitionRegistryPostProcessor</span><span class=o>)</span> <span class=o>{</span>
					<span class=n>BeanDefinitionRegistryPostProcessor</span> <span class=n>registryProcessor</span> <span class=o>=</span>
							<span class=o>(</span><span class=n>BeanDefinitionRegistryPostProcessor</span><span class=o>)</span> <span class=n>postProcessor</span><span class=o>;</span>
					<span class=n>registryProcessor</span><span class=o>.</span><span class=na>postProcessBeanDefinitionRegistry</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
					<span class=n>registryProcessors</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>registryProcessor</span><span class=o>);</span>
				<span class=o>}</span>
				<span class=k>else</span> <span class=o>{</span>
					<span class=n>regularPostProcessors</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>postProcessor</span><span class=o>);</span>
				<span class=o>}</span>
			<span class=o>}</span>

			<span class=c1>// Do not initialize FactoryBeans here: We need to leave all regular beans
</span><span class=c1></span>			<span class=c1>// uninitialized to let the bean factory post-processors apply to them!
</span><span class=c1></span>			<span class=c1>// Separate between BeanDefinitionRegistryPostProcessors that implement
</span><span class=c1></span>			<span class=c1>// PriorityOrdered, Ordered, and the rest.
</span><span class=c1></span>			<span class=n>List</span><span class=o>&lt;</span><span class=n>BeanDefinitionRegistryPostProcessor</span><span class=o>&gt;</span> <span class=n>currentRegistryProcessors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>

			<span class=c1>// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.
</span><span class=c1></span>      <span class=c1>// 先调用实现了PriorityOrdered接口的处理器
</span><span class=c1></span>      <span class=c1>// 从beanFactory中获取处理bean注册的类的beanName，本例中只有1个：org.springframework.context.annotation.internalConfigurationAnnotationProcessor,对应ConfigurationClassPostProcessor
</span><span class=c1></span>			<span class=n>String</span><span class=o>[]</span> <span class=n>postProcessorNames</span> <span class=o>=</span>
					<span class=n>beanFactory</span><span class=o>.</span><span class=na>getBeanNamesForType</span><span class=o>(</span><span class=n>BeanDefinitionRegistryPostProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
      <span class=c1>// 只添加实现了PriorityOrdered接口的postProcessor
</span><span class=c1></span>			<span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>ppName</span> <span class=o>:</span> <span class=n>postProcessorNames</span><span class=o>)</span> <span class=o>{</span>
				<span class=k>if</span> <span class=o>(</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>isTypeMatch</span><span class=o>(</span><span class=n>ppName</span><span class=o>,</span> <span class=n>PriorityOrdered</span><span class=o>.</span><span class=na>class</span><span class=o>))</span> <span class=o>{</span>
					<span class=n>currentRegistryProcessors</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=n>ppName</span><span class=o>,</span> <span class=n>BeanDefinitionRegistryPostProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
					<span class=n>processedBeans</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>ppName</span><span class=o>);</span>
				<span class=o>}</span>
			<span class=o>}</span>
      <span class=c1>// 排序
</span><span class=c1></span>			<span class=n>sortPostProcessors</span><span class=o>(</span><span class=n>currentRegistryProcessors</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>);</span>
      <span class=c1>// 添加registryProcessors中，加上第1步的2个，总共3个
</span><span class=c1></span>			<span class=n>registryProcessors</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>currentRegistryProcessors</span><span class=o>);</span>
      <span class=c1>// 这一步对已经注册的bean进行处理，包括主启动类demo，解析它的@SpringbootApplication注解，并解析其子注解，是Springboot注解驱动的重要实现,示例中的130多个bean在这里被注册
</span><span class=c1></span>			<span class=n>invokeBeanDefinitionRegistryPostProcessors</span><span class=o>(</span><span class=n>currentRegistryProcessors</span><span class=o>,</span> <span class=n>registry</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>.</span><span class=na>getApplicationStartup</span><span class=o>());</span>
			<span class=n>currentRegistryProcessors</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span> <span class=c1>// 清空列表
</span><span class=c1></span>
			<span class=c1>// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.
</span><span class=c1></span>      <span class=c1>// 在调用了实现Priority接口的处理器后，接着调用实现了Ordered接口的处理器
</span><span class=c1></span>      <span class=c1>//这里获取到org.springframework.context.annotation.internalConfigurationAnnotationProcessorp这个名字，不过在前面的for循环中已经被处理过，所以跳过了
</span><span class=c1></span>			<span class=n>postProcessorNames</span> <span class=o>=</span> <span class=n>beanFactory</span><span class=o>.</span><span class=na>getBeanNamesForType</span><span class=o>(</span><span class=n>BeanDefinitionRegistryPostProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
			<span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>ppName</span> <span class=o>:</span> <span class=n>postProcessorNames</span><span class=o>)</span> <span class=o>{</span>
				<span class=k>if</span> <span class=o>(!</span><span class=n>processedBeans</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>ppName</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>beanFactory</span><span class=o>.</span><span class=na>isTypeMatch</span><span class=o>(</span><span class=n>ppName</span><span class=o>,</span> <span class=n>Ordered</span><span class=o>.</span><span class=na>class</span><span class=o>))</span> <span class=o>{</span>
					<span class=n>currentRegistryProcessors</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=n>ppName</span><span class=o>,</span> <span class=n>BeanDefinitionRegistryPostProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
					<span class=n>processedBeans</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>ppName</span><span class=o>);</span>
				<span class=o>}</span>
			<span class=o>}</span>
      <span class=c1>// currentRegistryProcessors已经被清空，所以下面几步都没有实际作
</span><span class=c1></span>			<span class=n>sortPostProcessors</span><span class=o>(</span><span class=n>currentRegistryProcessors</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>);</span>
			<span class=n>registryProcessors</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>currentRegistryProcessors</span><span class=o>);</span>
			<span class=n>invokeBeanDefinitionRegistryPostProcessors</span><span class=o>(</span><span class=n>currentRegistryProcessors</span><span class=o>,</span> <span class=n>registry</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>.</span><span class=na>getApplicationStartup</span><span class=o>());</span>
			<span class=n>currentRegistryProcessors</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>

			<span class=c1>// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.
</span><span class=c1></span>      <span class=c1>// while循环的内容跟上面是一样的，现在处理剩下的没有实现PriorityOrdered和Ordered接口的bean,也只有internalConfigurationAnnotationProcessorp这个在processedBeans中已经存在的bean，所以while循环内也没有实际操作
</span><span class=c1></span>			<span class=kt>boolean</span> <span class=n>reiterate</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
			<span class=k>while</span> <span class=o>(</span><span class=n>reiterate</span><span class=o>)</span> <span class=o>{</span>
				<span class=n>reiterate</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
				<span class=n>postProcessorNames</span> <span class=o>=</span> <span class=n>beanFactory</span><span class=o>.</span><span class=na>getBeanNamesForType</span><span class=o>(</span><span class=n>BeanDefinitionRegistryPostProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
				<span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>ppName</span> <span class=o>:</span> <span class=n>postProcessorNames</span><span class=o>)</span> <span class=o>{</span>
					<span class=k>if</span> <span class=o>(!</span><span class=n>processedBeans</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>ppName</span><span class=o>))</span> <span class=o>{</span>
						<span class=n>currentRegistryProcessors</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=n>ppName</span><span class=o>,</span> <span class=n>BeanDefinitionRegistryPostProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
						<span class=n>processedBeans</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>ppName</span><span class=o>);</span>
						<span class=n>reiterate</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
					<span class=o>}</span>
				<span class=o>}</span>
				<span class=n>sortPostProcessors</span><span class=o>(</span><span class=n>currentRegistryProcessors</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>);</span>
				<span class=n>registryProcessors</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>currentRegistryProcessors</span><span class=o>);</span>
				<span class=n>invokeBeanDefinitionRegistryPostProcessors</span><span class=o>(</span><span class=n>currentRegistryProcessors</span><span class=o>,</span> <span class=n>registry</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>.</span><span class=na>getApplicationStartup</span><span class=o>());</span>
				<span class=n>currentRegistryProcessors</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
			<span class=o>}</span>

			<span class=c1>// Now, invoke the postProcessBeanFactory callback of all processors handled so far.
</span><span class=c1></span>      <span class=c1>// 调用registryProcessors中的后处理器去处理beanFactory中的所有bean,这里有效处理器只有ConfigurationClassPostProcessor这一个，遍历的bean有130多个
</span><span class=c1></span>			<span class=n>invokeBeanFactoryPostProcessors</span><span class=o>(</span><span class=n>registryProcessors</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>);.</span>
      <span class=c1>// 参数1是空，所以跳过
</span><span class=c1></span>			<span class=n>invokeBeanFactoryPostProcessors</span><span class=o>(</span><span class=n>regularPostProcessors</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>);</span>
		<span class=o>}</span>

		<span class=k>else</span> <span class=o>{</span>
			<span class=c1>// Invoke factory processors registered with the context instance.
</span><span class=c1></span>			<span class=n>invokeBeanFactoryPostProcessors</span><span class=o>(</span><span class=n>beanFactoryPostProcessors</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>);</span>
		<span class=o>}</span>



    <span class=c1>// 从当前的beanFactory取出所有BeanFactoryPostProcessor类型的bean，然后按照上面一样的流程，先分3类：PriorityOrdered，Ordered，nonOrdered3类，再按照这个顺序依次处理
</span><span class=c1></span>		<span class=c1>// Do not initialize FactoryBeans here: We need to leave all regular beans
</span><span class=c1></span>		<span class=c1>// uninitialized to let the bean factory post-processors apply to them!
</span><span class=c1></span>		<span class=n>String</span><span class=o>[]</span> <span class=n>postProcessorNames</span> <span class=o>=</span>
				<span class=n>beanFactory</span><span class=o>.</span><span class=na>getBeanNamesForType</span><span class=o>(</span><span class=n>BeanFactoryPostProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>

		<span class=c1>// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,
</span><span class=c1></span>		<span class=c1>// Ordered, and the rest.
</span><span class=c1></span>		<span class=n>List</span><span class=o>&lt;</span><span class=n>BeanFactoryPostProcessor</span><span class=o>&gt;</span> <span class=n>priorityOrderedPostProcessors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
		<span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>orderedPostProcessorNames</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
		<span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>nonOrderedPostProcessorNames</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
		<span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>ppName</span> <span class=o>:</span> <span class=n>postProcessorNames</span><span class=o>)</span> <span class=o>{</span>
			<span class=k>if</span> <span class=o>(</span><span class=n>processedBeans</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>ppName</span><span class=o>))</span> <span class=o>{</span>
				<span class=c1>// skip - already processed in first phase above
</span><span class=c1></span>			<span class=o>}</span>
			<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>isTypeMatch</span><span class=o>(</span><span class=n>ppName</span><span class=o>,</span> <span class=n>PriorityOrdered</span><span class=o>.</span><span class=na>class</span><span class=o>))</span> <span class=o>{</span>
				<span class=n>priorityOrderedPostProcessors</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=n>ppName</span><span class=o>,</span> <span class=n>BeanFactoryPostProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
			<span class=o>}</span>
			<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>isTypeMatch</span><span class=o>(</span><span class=n>ppName</span><span class=o>,</span> <span class=n>Ordered</span><span class=o>.</span><span class=na>class</span><span class=o>))</span> <span class=o>{</span>
				<span class=n>orderedPostProcessorNames</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>ppName</span><span class=o>);</span>
			<span class=o>}</span>
			<span class=k>else</span> <span class=o>{</span>
				<span class=n>nonOrderedPostProcessorNames</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>ppName</span><span class=o>);</span>
			<span class=o>}</span>
		<span class=o>}</span>

		<span class=c1>// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.
</span><span class=c1></span>		<span class=n>sortPostProcessors</span><span class=o>(</span><span class=n>priorityOrderedPostProcessors</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>);</span>
		<span class=n>invokeBeanFactoryPostProcessors</span><span class=o>(</span><span class=n>priorityOrderedPostProcessors</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>);</span>

		<span class=c1>// Next, invoke the BeanFactoryPostProcessors that implement Ordered.
</span><span class=c1></span>		<span class=n>List</span><span class=o>&lt;</span><span class=n>BeanFactoryPostProcessor</span><span class=o>&gt;</span> <span class=n>orderedPostProcessors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>orderedPostProcessorNames</span><span class=o>.</span><span class=na>size</span><span class=o>());</span>
		<span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>postProcessorName</span> <span class=o>:</span> <span class=n>orderedPostProcessorNames</span><span class=o>)</span> <span class=o>{</span>
			<span class=n>orderedPostProcessors</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=n>postProcessorName</span><span class=o>,</span> <span class=n>BeanFactoryPostProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
		<span class=o>}</span>
		<span class=n>sortPostProcessors</span><span class=o>(</span><span class=n>orderedPostProcessors</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>);</span>
		<span class=n>invokeBeanFactoryPostProcessors</span><span class=o>(</span><span class=n>orderedPostProcessors</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>);</span>

		<span class=c1>// Finally, invoke all other BeanFactoryPostProcessors.
</span><span class=c1></span>		<span class=n>List</span><span class=o>&lt;</span><span class=n>BeanFactoryPostProcessor</span><span class=o>&gt;</span> <span class=n>nonOrderedPostProcessors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>nonOrderedPostProcessorNames</span><span class=o>.</span><span class=na>size</span><span class=o>());</span>
		<span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>postProcessorName</span> <span class=o>:</span> <span class=n>nonOrderedPostProcessorNames</span><span class=o>)</span> <span class=o>{</span>
			<span class=n>nonOrderedPostProcessors</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=n>postProcessorName</span><span class=o>,</span> <span class=n>BeanFactoryPostProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>));</span>
		<span class=o>}</span>
		<span class=n>invokeBeanFactoryPostProcessors</span><span class=o>(</span><span class=n>nonOrderedPostProcessors</span><span class=o>,</span> <span class=n>beanFactory</span><span class=o>);</span>

		<span class=c1>// Clear cached merged bean definitions since the post-processors might have
</span><span class=c1></span>		<span class=c1>// modified the original metadata, e.g. replacing placeholders in values...
</span><span class=c1></span>		<span class=n>beanFactory</span><span class=o>.</span><span class=na>clearMetadataCache</span><span class=o>();</span>
	<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div></details>
<ul>
<li>
<p><code>registerBeanPostProcessors</code>：注册<code>beanPostProcessors</code>，先从<code>beanFactory</code>中获取<code>BeanPostProcessor</code>类型的相关信息，再生成对应的<code>bean</code>，最后注册到<code>beanFactory</code>的<code>beanPostProcessors</code>这个字段中。</p>
</li>
<li>
<p><code>finishBeanFactoryInitialization</code>：把<code>beanNames</code>里面所有还没有生成的bean全部生成，注册到<code>singletonObjects</code>并在<code>registeredSingletons</code>中添加名称，如果<code>bean</code>实现了<code>SmartInitializingSingleton</code>接口，则再调用其<code>afterSingletonsInstantiated</code>方法对<code>bean</code>进行一些额外的处理。在这一步控制台输出一条跟<code>ExecutorService</code>有关的信息。</p>
</li>
<li>
<p><code>finishRefresh</code>：释放一些资源，初始化跟<code>LifeCycle</code>有关的处理器(示例中是default的处理器)，然后调用这个处理器的<code>onRefresh</code>方法，这里启动了<code>Tomcat</code>，可以在控制台看到相关信息。接着发布了<code>ContextRefreshedEvent</code>类型的事件，去触发相应的操作。</p>
</li>
</ul>
<h2 id=3-总结>3 总结</h2>
<p>spring boot框架非常庞大，本文只是简单的跟着<code>run</code>方法走了一遍启动流程，源码中的一些实现细节也没法全部展开，可以在需要的时候打断点分析，而且示例中没有包含<code>AOP</code>的内容，所以后续流程中也没有涉及。<br>
总的来说，整个启动流程就是为了配置好<code>context</code>这个容器，其中包含了大量的监听器和事件的内容，在特定的步骤通过分发阶段性事件的方式来启动相应的工作。</p>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>版权声明</span>
<span class=item-content>本博客使用<a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh# target=_blank>CC BY-NC-SA 4.0</a>许可协议(创意共享4.0:保留署名-非商业性使用-相同方式共享)。</span>
</p>
</div>
<footer class=post-footer>
<nav class=post-nav>
<a class=prev href=/jvm%E4%B9%8B%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA%E5%9F%9F/>
<i class="iconfont icon-left"></i>
<span class="prev-text nav-default">jvm之运行时数据区域</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/lua%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8/>
<span class="next-text nav-default">lua语言入门</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i>
</a>
</nav>
</footer>
</article>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=social-links>
<a href=https://github.com/ozryan class="iconfont icon-github" title=github></a>
<a href=https://www.fewth.com/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a>
</div>
<div class=copyright>
<span class=copyright-year>
&copy;
2020 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>ozryan</span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class="iconfont icon-up"></i>
</div>
</div>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js></script>
<script type=text/javascript>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]}}</script>
<script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script>
</body>
</html>